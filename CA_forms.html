<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA's Interactive Form Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Chosen Palette: Professional Indigo (Slate Background, White Cards, Indigo/Teal Accents) -->
    <!-- Application Structure Plan: A master-detail, two-column responsive layout. The left column (master) contains main navigation, search, and the filterable list of forms. The right column (detail) is a content pane that displays the relevant view: 'Overview' (with chart and new Due Dates block), 'Form Details' (when a form is selected), or 'Compliance Copilot'. This structure is chosen for a neat, tidy UX, eliminating layout shift and providing a focused workflow. Users browse the list and view details in a separate, persistent panel. -->
    <!-- Visualization & Content Choices: 
        1. Report Info: Form Counts. Goal: Inform. Viz: Donut Chart (Chart.js/Canvas). Interaction: Hover. Location: 'Overview' pane. Library: Chart.js.
        2. Report Info: Upcoming Due Dates. Goal: Inform, Prioritize. Viz: Dynamic List (HTML/JS). Interaction: Click item to load form details. Justification: Adds high-value, timely info to the dashboard. Library: Vanilla JS.
        3. Report Info: All forms. Goal: Organize, Select. Viz: Master List (HTML/Tailwind Buttons). Interaction: 1. Main Tab (JS filter list). 2. Sub-Tab (JS filter list). 3. Search (JS filter list). 4. Click (JS load details in right pane). Justification: Cleaner, no layout shift. Library: Vanilla JS.
        4. Report Info: Form Details (Gemini). Goal: Inform, Retrieve. Viz: Single content pane. Interaction: Click form to auto-load Gemini details, with 30-day localStorage caching. Justification: Removed tabs for a simpler, "live-first" UX. Caching adds performance. Library: Vanilla JS, Gemini API.
        5. Report Info: Procedural Q&A (Gemini). Goal: Advise. Viz: 'Compliance Copilot' pane. Interaction: Text input + Submit. Justification: Integrates Q&A as a primary app mode. Library: Vanilla JS, Gemini API.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <style>
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin: auto;
            height: 300px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        .main-nav-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: #475569; /* text-slate-600 */
            border-radius: 0.5rem;
            transition: all 200ms;
        }
        .main-nav-button:hover {
            background-color: #f1f5f9; /* hover:bg-slate-100 */
        }
        .main-nav-button.active {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: #ffffff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
        }
        .main-nav-button.active:hover {
            background-color: #4f46e5; /* hover:bg-indigo-600 */
        }
        
        .sub-nav-button {
            padding: 0.25rem 0.75rem;
            font-weight: 500;
            font-size: 0.75rem;
            border-radius: 9999px;
            transition: all 200ms;
            cursor: pointer;
        }
        .sub-nav-button.active {
            background-color: #ccfbf1; /* bg-teal-100 */
            color: #115e59; /* text-teal-800 */
            font-weight: 600;
        }
        .sub-nav-button.inactive {
            background-color: #f1f5f9; /* bg-slate-100 */
            color: #334155; /* text-slate-700 */
        }
        .sub-nav-button.inactive:hover {
            background-color: #e2e8f0; /* hover:bg-slate-200 */
        }

        .form-list-button {
            display: block; 
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: #334155; /* text-slate-700 */
            border-radius: 0.5rem;
            transition: all 150ms;
        }
        .form-list-button:hover {
            background-color: #f1f5f9; /* hover:bg-slate-100 */
        }
        .form-list-button.active {
            background-color: #eef2ff; /* bg-indigo-50 */
            font-weight: 600;
            color: #4338ca; /* text-indigo-700 */
        }

        .detail-pane {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
            border: 1px solid #e2e8f0; /* border-slate-200 */
            height: calc(100vh - 12rem);
            overflow-y: auto;
        }
        @media (min-width: 768px) {
            .detail-pane {
                height: calc(100vh - 5rem);
            }
        }
        
        .copilot-submit-btn {
            margin-top: 1.5rem;
            padding: 0.625rem 1.25rem;
            background-color: #4f46e5; /* bg-indigo-600 */
            color: #ffffff;
            font-weight: 500;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color); /* shadow-md */
            --tw-shadow-color: #c7d2fe; /* shadow-indigo-100 */
            transition: all 200ms;
            width: 100%;
        }
        .copilot-submit-btn:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
            box-shadow: 0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color); /* hover:shadow-lg */
            --tw-shadow-color: #a5b4fc; /* hover:shadow-indigo-200 */
        }
        .copilot-submit-btn:disabled {
            background-color: #cbd5e1; /* disabled:bg-slate-300 */
            box-shadow: none;
        }
        
        .copilot-example-btn {
            padding: 0.25rem 0.75rem;
            background-color: #f1f5f9; /* bg-slate-100 */
            color: #334155; /* text-slate-700 */
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            transition: all 200ms;
            cursor: pointer;
        }
        .copilot-example-btn:hover {
            background-color: #e2e8f0; /* hover:bg-slate-200 */
        }

        .spinner {
            width: 1.5rem;
            height: 1.5rem;
            border-width: 2px;
            border-color: #cbd5e1; /* border-slate-300 */
            border-top-color: #4f46e5; /* border-t-indigo-600 */
            border-radius: 9999px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .gemini-source-list {
            list-style-type: disc;
            list-style-position: inside;
            font-size: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #cbd5e1; /* border-slate-300 */
        }
        .gemini-source-list li {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .gemini-source-list a {
            color: #4f46e5; /* text-indigo-600 */
        }
        .gemini-source-list a:hover {
            text-decoration: underline;
        }

        .due-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .due-date-item:hover {
            background-color: #f1f5f9; /* hover:bg-slate-100 */
        }
        .due-date-item-urgent {
            background-color: #fef2f2; /* bg-red-50 */
        }
        .due-date-item-urgent:hover {
            background-color: #fee2e2; /* hover:bg-red-100 */
        }
        
        .due-date-days {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
        }
        .due-date-days-urgent {
            background-color: #fee2e2; /* bg-red-100 */
            color: #991b1b; /* text-red-800 */
        }
        .due-date-days-soon {
            background-color: #fefce8; /* bg-yellow-100 */
            color: #854d0e; /* text-yellow-800 */
        }
        .due-date-days-later {
            background-color: #f1f5f9; /* bg-slate-100 */
            color: #334155; /* text-slate-700 */
        }

    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans leading-relaxed">

    <div class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Left "Master" Column -->
        <aside class="w-full md:w-80 lg:w-96 p-4 space-y-4 border-b md:border-b-0 md:border-r border-slate-200 bg-white md:h-screen flex flex-col">
            
            <div class="flex-grow space-y-4 overflow-y-auto">
                <h1 class="text-2xl font-bold text-indigo-800 px-2">CA Form Guide</h1>

                <!-- Main Navigation -->
                <nav class="space-y-1">
                    <button class="main-nav-button w-full active" data-page="overview">
                        <span class="text-xl">üìä</span><span>Overview</span>
                    </button>
                    <button class="main-nav-button w-full" data-page="copilot">
                        <span class="text-xl">‚ú®</span><span>Compliance Copilot</span>
                    </button>
                    <button class="main-nav-button w-full" data-page="mca">
                        <span class="text-xl">üè¢</span><span>Company Law (MCA)</span>
                    </button>
                    <button class="main-nav-button w-full" data-page="cbdt">
                        <span class="text-xl">üí∞</span><span>Direct Tax (CBDT)</span>
                    </button>
                    <button class="main-nav-button w-full" data-page="gstn">
                        <span class="text-xl">üßæ</span><span>Indirect Tax (GST)</span>
                    </button>
                </nav>

                <hr id="master-divider" class="hidden">

                <!-- Search Bar -->
                <div id="search-bar-container" class="relative hidden">
                    <input type="text" id="search-bar" placeholder="Search forms..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl">üîç</span>
                </div>
                
                <!-- Sub Navigation -->
                <nav id="sub-nav-container" class="flex flex-wrap gap-2 mb-6 hidden" data-category="">
                    <!-- Sub-nav buttons injected here -->
                </nav>

                <!-- Form List -->
                <div id="form-list-container" class="space-y-1">
                    <!-- Form list buttons will be injected here -->
                </div>
                
                <div id="no-results" class="hidden text-center py-12">
                    <span class="text-4xl mb-2 block">üö´</span>
                    <h3 class="font-semibold text-slate-700">No Forms Found</h3>
                    <p class="text-sm text-slate-500">Try adjusting your search.</p>
                </div>
            </div>
            
            <div class="mt-auto pt-4 text-center text-xs text-slate-500">
                Made by CA Ignatius Mathew Abel
            </div>

        </aside>

        <!-- Right "Detail" Column -->
        <main id="detail-pane" class="flex-1 p-4">
            <div id="detail-pane-content" class="detail-pane">
                <!-- Content will be injected here -->
            </div>
        </main>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const apiKey = "AIzaSyD4nPHFudp-ThHei7zpIYqxw_4_RYkqOl0"; 
            const CACHE_KEY_PREFIX = 'ca_form_details_';
            const CACHE_DURATION_MS = 30 * 24 * 60 * 60 * 1000; // 30 days

            const formDB = [
                // MCA Forms
                { id: 'mca1', name: 'SPICe+ (INC-32)', desc: 'Simplified Proforma for Incorporating Company Electronically Plus', category: 'mca', subCategory: 'incorporation', searchTerm: 'spice+ inc-32 incorporation' },
                { id: 'mca2', name: 'INC-33 (e-MOA)', desc: 'Electronic Memorandum of Association', category: 'mca', subCategory: 'incorporation', searchTerm: 'inc-33 e-moa memorandum' },
                { id: 'mca3', name: 'INC-34 (e-AOA)', desc: 'Electronic Articles of Association', category: 'mca', subCategory: 'incorporation', searchTerm: 'inc-34 e-aoa articles' },
                { id: 'mca4', name: 'AOC-4', desc: 'Form for filing financial statements', category: 'mca', subCategory: 'annual', searchTerm: 'aoc-4 financial statements', dueDateType: 'annual', staticDate: '2025-10-30', dueDesc: '30 days from AGM (latest by 30th Oct)' },
                { id: 'mca5', name: 'MGT-7', desc: 'Annual Return form', category: 'mca', subCategory: 'annual', searchTerm: 'mgt-7 annual return', dueDateType: 'annual', staticDate: '2025-11-29', dueDesc: '60 days from AGM (latest by 29th Nov)' },
                { id: 'mca6', name: 'ADT-1', desc: 'Auditor Appointment', category: 'mca', subCategory: 'annual', searchTerm: 'adt-1 auditor appointment' },
                { id: 'mca7', name: 'DIR-3 KYC', desc: 'Directors KYC', category: 'mca', subCategory: 'annual', searchTerm: 'kyc-3 dir-3 kyc director', dueDateType: 'annual', staticDate: '2025-09-30', dueDesc: 'Annual KYC for Directors' },
                { id: 'mca8', name: 'DIR-12', desc: 'Change in Directors', category: 'mca', subCategory: 'event-based', searchTerm: 'dir-12 change directors' },
                { id: 'mca9', name: 'PAS-3', desc: 'Return of Allotment', category: 'mca', subCategory: 'event-based', searchTerm: 'pas-3 return of allotment shares' },
                { id: 'mca10', name: 'SH-7', desc: 'Change in Share Capital', category: 'mca', subCategory: 'event-based', searchTerm: 'sh-7 change authorized share capital' },
                { id: 'mca11', name: 'CHG-1', desc: 'Creation of Charge', category: 'mca', subCategory: 'event-based', searchTerm: 'chg-1 creation modification charge' },
                { id: 'mca12', name: 'MGT-14', desc: 'Filing of Resolutions and Agreements', category: 'mca', subCategory: 'event-based', searchTerm: 'mgt-14 resolutions special ordinary agreement' },
                { id: 'mca13', name: 'INC-20A', desc: 'Declaration for Commencement of Business', category: 'mca', subCategory: 'event-based', searchTerm: 'inc-20a commencement business' },
                { id: 'mca14', name: 'DPT-3', desc: 'Return of Deposits', category: 'mca', subCategory: 'annual', searchTerm: 'dpt-3 deposits', dueDateType: 'annual', staticDate: '2025-06-30', dueDesc: 'Annual return of deposits' },
                { id: 'mca15', name: 'MSME-1', desc: 'Return on dues to MSME', category: 'mca', subCategory: 'annual', searchTerm: 'msme-1 micro small medium enterprises dues', dueDateType: 'half-yearly', staticDate: '2025-10-31', dueDesc: 'Half-yearly return (Apr-Sep due 31st Oct)' },
                { id: 'mca16', name: 'CHG-4', desc: 'Satisfaction of Charge', category: 'mca', subCategory: 'event-based', searchTerm: 'chg-4 satisfaction charge loan' },

                // CBDT Forms
                { id: 'cbdt10', name: 'ITR-1 (Sahaj)', desc: 'ITR for Salaried Individuals (up to 50L)', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-1 sahaj salary one house', dueDateType: 'annual', staticDate: '2025-07-31', dueDesc: 'For non-audit individuals' },
                { id: 'cbdt11', name: 'ITR-2', desc: 'ITR for Individuals/HUFs (No PGBP)', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-2 capital gains foreign income', dueDateType: 'annual', staticDate: '2025-07-31', dueDesc: 'For non-audit individuals/HUFs' },
                { id: 'cbdt1', name: 'ITR-3', desc: 'ITR for PGBP income', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-3 income tax return business profession', dueDateType: 'annual', staticDate: '2025-10-31', dueDesc: 'For audit-case individuals/HUFs' },
                { id: 'cbdt2', name: 'ITR-4 (Sugam)', desc: 'ITR for Presumptive Income', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-4 sugam presumptive 44ad', dueDateType: 'annual', staticDate: '2025-07-31', dueDesc: 'For presumptive income individuals' },
                { id: 'cbdt3', name: 'ITR-5', desc: 'ITR for Firms, LLPs', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-5 partnership firms llp', dueDateType: 'annual', staticDate: '2025-10-31', dueDesc: 'For firms/LLPs (audit case)' },
                { id: 'cbdt4', name: 'ITR-6', desc: 'ITR for Companies', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-6 companies', dueDateType: 'annual', staticDate: '2025-10-31', dueDesc: 'For companies (non-TP)' },
                { id: 'cbdt12', name: 'ITR-7', desc: 'ITR for Trusts/Charitable Institutions', category: 'cbdt', subCategory: 'itr', searchTerm: 'itr-7 trust non-profit section 11', dueDateType: 'annual', staticDate: '2025-10-31', dueDesc: 'For trusts/institutions' },
                { id: 'cbdt5', name: 'Form 3CA-3CD', desc: 'Tax Audit Report (Company)', category: 'cbdt', subCategory: 'audit', searchTerm: '3ca 3cd tax audit report', dueDateType: 'annual', staticDate: '2025-09-30', dueDesc: 'Tax Audit Report' },
                { id: 'cbdt6', name: 'Form 3CB-3CD', desc: 'Tax Audit Report (Other)', category: 'cbdt', subCategory: 'audit', searchTerm: '3cb 3cd tax audit report', dueDateType: 'annual', staticDate: '2025-09-30', dueDesc: 'Tax Audit Report' },
                { id: 'cbdt7', name: 'Form 24Q', desc: 'Quarterly TDS Return (Salary)', category: 'cbdt', subCategory: 'tds-tcs', searchTerm: '24q tds return salary' },
                { id: 'cbdt8', name: 'Form 26Q', desc: 'Quarterly TDS Return (Non-Salary)', category: 'cbdt', subCategory: 'tds-tcs', searchTerm: '26q tds return non-salary' },
                { id: 'cbdt9', name: 'Form 15CA / 15CB', desc: 'Remittance Certificate', category: 'cbdt', subCategory: 'other', searchTerm: '15ca 15cb remittance non-resident' },
                { id: 'cbdt13', name: 'Form 26AS', desc: 'Annual Tax Statement', category: 'cbdt', subCategory: 'other', searchTerm: '26as annual tax statement tds tcs' },
                { id: 'cbdt14', name: 'Form 10E', desc: 'Relief u/s 89(1) (Salary Arrears)', category: 'cbdt', subCategory: 'other', searchTerm: '10e salary arrears relief 89' },

                // GSTN Forms
                { id: 'gst6', name: 'REG-01', desc: 'GST Registration Application', category: 'gstn', subCategory: 'registration', searchTerm: 'reg-01 registration' },
                { id: 'gst8', name: 'REG-14', desc: 'Application for Amendment in Registration', category: 'gstn', subCategory: 'registration', searchTerm: 'reg-14 amendment' },
                { id: 'gst9', name: 'REG-29', desc: 'Application for Cancellation of Registration', category: 'gstn', subCategory: 'registration', searchTerm: 'reg-29 cancellation' },
                { id: 'gst1', name: 'GSTR-1', desc: 'Return for Outward Supplies', category: 'gstn', subCategory: 'periodic', searchTerm: 'gstr-1 outward supplies sales', dueDateType: 'monthly', baseDate: 11, dueDesc: 'Monthly (for >5 Cr TO)' },
                { id: 'gst2', name: 'GSTR-3B', desc: 'Summary Return', category: 'gstn', subCategory: 'periodic', searchTerm: 'gstr-3b summary return liability payment', dueDateType: 'monthly', baseDate: 20, dueDesc: 'Monthly' },
                { id: 'gst3', name: 'CMP-08', desc: 'Composition Scheme Return', category: 'gstn', subCategory: 'periodic', searchTerm: 'cmp-08 composition scheme' },
                { id: 'gst10', name: 'ITC-04', desc: 'Return for Job Work', category: 'gstn', subCategory: 'periodic', searchTerm: 'itc-04 job work' },
                { id: 'gst7', name: 'GSTR-4', desc: 'Annual Return for Composition Dealers', category: 'gstn', subCategory: 'annual', searchTerm: 'gstr-4 composition annual', dueDateType: 'annual', staticDate: '2025-04-30', dueDesc: 'Annual for Composition Dealers' },
                { id: 'gst4', name: 'GSTR-9', desc: 'Annual GST Return', category: 'gstn', subCategory: 'annual', searchTerm: 'gstr-9 annual return', dueDateType: 'annual', staticDate: '2025-12-31', dueDesc: 'For FY 2024-25' },
                { id: 'gst5', name: 'GSTR-9C', desc: 'Reconciliation Statement', category: 'gstn', subCategory: 'annual', searchTerm: 'gstr-9c reconciliation statement ca', dueDateType: 'annual', staticDate: '2025-12-31', dueDesc: 'For FY 2024-25' }
            ];

            const subCategories = {
                mca: ['All', 'Incorporation', 'Annual', 'Event-Based'],
                cbdt: ['All', 'ITR', 'Audit', 'TDS-TCS', 'Other'],
                gstn: ['All', 'Registration', 'Periodic', 'Annual']
            };

            const mainNavButtons = document.querySelectorAll('.main-nav-button');
            const detailPane = document.getElementById('detail-pane-content');
            const searchBarContainer = document.getElementById('search-bar-container');
            const searchBar = document.getElementById('search-bar');
            const subNavContainer = document.getElementById('sub-nav-container');
            const formListContainer = document.getElementById('form-list-container');
            const noResults = document.getElementById('no-results');
            const masterDivider = document.getElementById('master-divider');

            const today = new Date('2025-10-26T08:00:00'); 

            async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 400) {
                             const errorBody = await response.json();
                             if (errorBody.error?.message?.includes('API key not valid')) {
                                return { error: "API key not valid. Please check the key in the script." };
                             }
                        }
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`API Error: ${response.status}`);
                        }
                        return await response.json(); 
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    } else {
                        return { error: `Failed to fetch after multiple retries: ${error.message}` };
                    }
                }
            }
            
            function parseMarkdown(text) {
                return text
                    .replace(/^## (.*$)/gim, '<h2 class="text-lg font-semibold text-slate-800 mt-4 mb-2">$1</h2>')
                    .replace(/^### (.*$)/gim, '<h3 class="text-md font-semibold text-slate-700 mt-4 mb-1">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^\* (.*$)/gim, '<li class="list-disc list-inside ml-2">$1</li>');
            }

            // Function to get cached data
            function getCachedData(key) {
                try {
                    const item = localStorage.getItem(key);
                    if (!item) return null;

                    const { timestamp, data } = JSON.parse(item);
                    const isExpired = (Date.now() - timestamp) > CACHE_DURATION_MS;
                    
                    if (isExpired) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return data;
                } catch (error) {
                    return null;
                }
            }

            // Function to set cached data
            function setCachedData(key, data) {
                try {
                    const item = {
                        timestamp: Date.now(),
                        data: data
                    };
                    localStorage.setItem(key, JSON.stringify(item));
                } catch (error) {
                    localStorage.clear();
                }
            }

            async function fetchGroundedFormDetailsInline(formName, formDesc, formId, container) {
                container.innerHTML = `<div class="flex items-center justify-center h-32"><div class="flex items-center gap-2 text-slate-500"><div class="spinner"></div><span>Checking for details...</span></div></div>`;
                
                const cacheKey = `${CACHE_KEY_PREFIX}${formId}`;
                const cachedData = getCachedData(cacheKey);

                if (cachedData) {
                    container.innerHTML = `<div class="text-slate-700 text-sm">${cachedData.html}</div>`;
                    return;
                }

                container.innerHTML = `<div class="flex items-center justify-center h-32"><div class="flex items-center gap-2 text-slate-500"><div class="spinner"></div><span>Fetching current details...</span></div></div>`;

                if (apiKey === "YOUR_API_KEY_HERE" || !apiKey) {
                    container.innerHTML = `<span class="text-red-600 p-4 block"><b>Error:</b> API key is missing. Please add your key to the \`apiKey\` variable in the script to use this feature.</span>`;
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const userQuery = `Provide a reader-friendly summary for an Indian Chartered Accountant about the form ${formName} (${formDesc}). Include:
- Its main purpose.
- The current due date (for the latest financial year).
- Standard late filing fees or penalties.
- A brief, bulleted summary of the filing process.
Format the entire response clearly using markdown.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: "You are a concise Indian compliance expert. Provide only the requested information. Format the answer clearly using markdown headings, bold text, and bullet points." }] },
                };

                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.error) {
                    container.innerHTML = `<span class="text-red-600 p-4 block"><b>Error:</b> ${result.error}</span>`;
                    return;
                }
                if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    container.innerHTML = `<span class="text-red-600 p-4 block">Sorry, I couldn't fetch details at this time. Please try again later.</span>`;
                    return;
                }

                let text = parseMarkdown(result.candidates[0].content.parts[0].text);

                let sourcesHtml = '';
                const groundingMetadata = result.candidates[0].groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => attr.web?.uri && attr.web?.title ? { uri: attr.web.uri, title: attr.web.title } : null)
                        .filter(Boolean);
                    
                    if (sources.length > 0) {
                        sourcesHtml = '<div class="gemini-source-list"><h4 class="font-semibold text-sm text-slate-600 mb-2">Sources:</h4>';
                        sources.forEach(source => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</div>';
                    }
                }
                
                const finalHtml = `<div class="text-slate-700 text-sm">${text}${sourcesHtml}</div>`;
                container.innerHTML = finalHtml;
                
                // Save the successful result to cache
                setCachedData(cacheKey, { html: finalHtml });
            }

            async function fetchCopilotAdvice(query, resultBox, submitBtn) {
                if (!query) {
                    resultBox.innerHTML = '<span class="text-red-600">Please enter a situation description.</span>';
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Thinking...';
                resultBox.innerHTML = '<div class="flex items-center justify-center h-full"><div class="flex items-center gap-2 text-slate-500"><div class="spinner"></div><span>Thinking...</span></div></div>';

                if (apiKey === "YOUR_API_KEY_HERE" || !apiKey) {
                    resultBox.innerHTML = `<span class="text-red-600"><b>Error:</b> API key is missing. Please add your key to the \`apiKey\` variable in the script to use this feature.</span>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Get Advice';
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const systemPrompt = "You are an expert Chartered Accountant (CA) in India. A user is asking for advice on compliance. Based on their situation, identify the most relevant MCA, Income Tax (CBDT), or GST forms, and provide a clear, concise, step-by-step action plan. Do not give financial advice, only procedural and form-related guidance. Be friendly and professional. Format your response with clear markdown headings and bullet points.";

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.error) {
                    resultBox.innerHTML = `<span class="text-red-600"><b>Error:</b> ${result.error}</span>`;
                } else if (!result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    resultBox.innerHTML = `<span class="text-red-600">Sorry, I couldn't generate advice at this time.</span>`;
                } else {
                    resultBox.innerHTML = parseMarkdown(result.candidates[0].content.parts[0].text);
                }
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get Advice';
            }

            function renderOverviewPage() {
                const formCounts = {
                    mca: formDB.filter(f => f.category === 'mca').length,
                    cbdt: formDB.filter(f => f.category === 'cbdt').length,
                    gstn: formDB.filter(f => f.category === 'gstn').length
                };

                detailPane.innerHTML = `
                    <div class="p-4 md:p-8 space-y-8">
                        <div>
                            <h2 class="text-2xl font-bold text-indigo-800 mb-2">Welcome, CA!</h2>
                            <p class="text-lg text-slate-600">Here's your compliance overview for ${today.toDateString()}.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-xl font-semibold text-indigo-700 mb-4">Upcoming Due Dates (Next 30 Days)</h3>
                                <div id="due-date-list" class="space-y-2">
                                    <!-- Due dates will be rendered here -->
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="text-xl font-semibold text-indigo-700 mb-4">Forms Distribution</h3>
                                <div class="chart-container">
                                    <canvas id="overview-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                renderUpcomingDueDates();

                const ctx = document.getElementById('overview-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Company Law (MCA)', 'Direct Tax (CBDT)', 'Indirect Tax (GST)'],
                        datasets: [{
                            label: 'Number of Forms',
                            data: [formCounts.mca, formCounts.cbdt, formCounts.gstn],
                            backgroundColor: ['#4f46e5', '#f97316', '#16a34a'],
                            borderColor: '#ffffff',
                            borderWidth: 4,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 20, boxWidth: 12, font: { size: 14 } }
                            }
                        }
                    }
                });
            }

            function renderUpcomingDueDates() {
                const listEl = document.getElementById('due-date-list');
                if (!listEl) return;

                const upcoming = [];
                const oneDay = 1000 * 60 * 60 * 24;
                
                formDB.forEach(form => {
                    if (!form.dueDateType) return;

                    let dueDate;
                    if (form.dueDateType === 'monthly') {
                        dueDate = new Date(today.getFullYear(), today.getMonth(), form.baseDate);
                        if (today.getDate() > form.baseDate) {
                            dueDate.setMonth(dueDate.getMonth() + 1);
                        }
                    } else if (form.dueDateType === 'half-yearly') {
                        let formDate = new Date(form.staticDate); // e.g., Oct 31
                        let year = today.getFullYear();
                        let currentYearDueDate = new Date(year, formDate.getMonth(), formDate.getDate()); // Oct 31, 2025
                        
                        if (today > currentYearDueDate) {
                            // If today is Nov 1, 2025, the next due date is Apr 30, 2026
                            let nextDueDate = new Date(year, formDate.getMonth() + 6, formDate.getDate());
                            dueDate = nextDueDate;
                        } else {
                            // If today is Oct 26, 2025, the due date is Oct 31, 2025
                            dueDate = currentYearDueDate;
                        }

                    } else if (form.dueDateType === 'annual') {
                        let formDate = new Date(form.staticDate);
                        let year = today.getFullYear();
                        let currentYearDueDate = new Date(year, formDate.getMonth(), formDate.getDate());
                        
                        if (today > currentYearDueDate) {
                            dueDate = new Date(year + 1, formDate.getMonth(), formDate.getDate());
                        } else {
                            dueDate = currentYearDueDate;
                        }
                    }

                    if (dueDate) {
                        const daysRemaining = Math.ceil((dueDate.getTime() - today.getTime()) / oneDay);
                        if (daysRemaining >= 0 && daysRemaining <= 30) {
                            upcoming.push({ ...form, dueDate, daysRemaining });
                        }
                    }
                });

                upcoming.sort((a, b) => a.daysRemaining - b.daysRemaining);

                if (upcoming.length === 0) {
                    listEl.innerHTML = `<p class="text-slate-500 text-sm">No major due dates found in the next 30 days.</p>`;
                    return;
                }

                listEl.innerHTML = upcoming.map(form => {
                    let daysClass = 'due-date-days-later';
                    if (form.daysRemaining <= 7) daysClass = 'due-date-days-urgent';
                    else if (form.daysRemaining <= 15) daysClass = 'due-date-days-soon';
                    
                    let itemClass = 'due-date-item ' + ((form.daysRemaining <= 7) ? 'due-date-item-urgent' : '');

                    return `
                        <div class="${itemClass}" data-form-id="${form.id}">
                            <div>
                                <p class="font-medium text-slate-800">${form.name}</p>
                                <p class="text-sm text-slate-600">Due: ${form.dueDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</p>

                            </div>
                            <span class="${'due-date-days ' + daysClass}">
                                ${form.daysRemaining === 0 ? 'Today' : `${form.daysRemaining} days`}
                            </span>
                        </div>
                    `;
                }).join('');

                listEl.querySelectorAll('.due-date-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const formId = item.dataset.formId;
                        const form = formDB.find(f => f.id === formId);
                        if (form) {
                            mainNavButtons.forEach(btn => btn.classList.remove('active'));
                            document.querySelector(`.main-nav-button[data-page="${form.category}"]`).classList.add('active');
                            showPage(form.category, formId);
                        }
                    });
                });
            }

            function renderCopilotPage() {
                detailPane.innerHTML = `
                    <div class="p-4 md:p-8">
                        <h2 class="text-2xl font-bold text-indigo-800 mb-2">‚ú® Compliance Copilot</h2>
                        <p class="text-lg text-slate-600 mb-6">Your AI assistant for compliance procedures.</p>
                        
                        <div class="lg:grid lg:grid-cols-2 lg:gap-8">
                            <div>
                                <label for="copilot-query" class="block text-sm font-medium text-slate-700 mb-2">Describe your situation:</label>
                                <textarea id="copilot-query" rows="4" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., My client appointed a new director. What is the process?"></textarea>
                                
                                <div class="mt-4">
                                    <h4 class="text-xs font-semibold text-slate-500 mb-2">Or, try an example:</h4>
                                    <div id="copilot-examples" class="flex flex-wrap gap-2">
                                        <button class="copilot-example-btn" data-prompt="My client is appointing a new director. What forms are needed?">Director Appointment</button>
                                        <button class="copilot-example-btn" data-prompt="What forms are needed for a new private limited company to file its first annual return?">First Annual Return</button>
                                        <button class="copilot-example-btn" data-prompt="A client missed their GSTR-3B due date. What are the consequences?">Missed GSTR-3B</button>
                                    </div>
                                </div>
                                <button id="copilot-submit" class="copilot-submit-btn">Get Advice</button>
                            </div>
                            
                            <div class="mt-6 lg:mt-0">
                                <h3 class="text-xl font-semibold text-slate-800 mb-2">Copilot's Advice</h3>
                                <div id="copilot-result" class="p-4 border border-slate-200 rounded-lg shadow-sm min-h-[200px] lg:h-full whitespace-pre-wrap bg-slate-50 text-slate-700">
                                    Your advice will appear here...
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const queryInput = document.getElementById('copilot-query');
                const resultBox = document.getElementById('copilot-result');
                const submitBtn = document.getElementById('copilot-submit');

                document.getElementById('copilot-examples').addEventListener('click', (e) => {
                    if (e.target.matches('.copilot-example-btn')) {
                        queryInput.value = e.target.dataset.prompt;
                        queryInput.focus();
                    }
                });
                
                submitBtn.addEventListener('click', () => fetchCopilotAdvice(queryInput.value, resultBox, submitBtn));
            }

            function renderFormListPage(category) {
                subNavContainer.innerHTML = subCategories[category].map((sub, index) => {
                    const filter = sub.toLowerCase().replace(/ /g, '-').replace(/\//g, '-');
                    const activeClass = index === 0 ? 'active' : 'inactive';
                    return `<button class="sub-nav-button ${activeClass}" data-filter="${filter}">${sub}</button>`;
                }).join('');
                
                subNavContainer.dataset.category = category;
                subNavContainer.classList.remove('hidden');
                searchBarContainer.classList.remove('hidden');
                masterDivider.classList.remove('hidden');
                
                filterFormList();

                detailPane.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center text-slate-500">
                            <span class="text-6xl">‚Üê</span>
                            <h2 class="text-xl font-medium mt-4">Select a form</h2>
                            <p>Choose a form from the list to see its details.</p>
                        </div>
                    </div>
                `;
            }

            function filterFormList(activeFormId = null) {
                const category = subNavContainer.dataset.category;
                const activeSubFilter = subNavContainer.querySelector('.sub-nav-button.active').dataset.filter;
                const searchTerm = searchBar.value.toLowerCase();

                const filteredForms = formDB.filter(form => {
                    const categoryMatch = form.category === category;
                    const subCategoryMatch = (activeSubFilter === 'all') || (form.subCategory === activeSubFilter);
                    const searchMatch = (searchTerm === '') || (form.searchTerm.includes(searchTerm));
                    return categoryMatch && subCategoryMatch && searchMatch;
                });
                
                if (filteredForms.length === 0) {
                    formListContainer.innerHTML = '';
                    noResults.classList.remove('hidden');
                } else {
                    noResults.classList.add('hidden');
                    formListContainer.innerHTML = filteredForms.map(form => {
                        const isActive = form.id === activeFormId;
                        return `<button class="form-list-button ${isActive ? 'active' : ''}" data-form-id="${form.id}">${form.name}</button>`;
                    }).join('');
                }
            }

            function loadFormDetails(formId) {
                const form = formDB.find(f => f.id === formId);
                if (!form) return;

                filterFormList(formId); 

                detailPane.innerHTML = `
                    <div class="p-4 md:p-8">
                        <h2 class="text-2xl font-bold text-indigo-800 mb-1">${form.name}</h2>
                        <p class="text-lg text-slate-600 mb-6">${form.desc}</p>
                        
                        <hr class="mb-6 border-slate-200">
                        
                        <div id="live-details-content" class="whitespace-pre-wrap">
                            <!-- Live details will be loaded here automatically -->
                        </div>
                    </div>
                `;

                const contentBox = document.getElementById('live-details-content');
                fetchGroundedFormDetailsInline(form.name, form.desc, form.id, contentBox);
            }

            function showPage(page, loadFormId = null) {
                mainNavButtons.forEach(btn => {
                    if (btn.dataset.page === page) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                searchBar.value = '';
                
                if (page === 'overview') {
                    renderOverviewPage();
                    searchBarContainer.classList.add('hidden');
                    subNavContainer.classList.add('hidden');
                    formListContainer.innerHTML = '';
                    noResults.classList.add('hidden');
                    masterDivider.classList.add('hidden');
                } else if (page === 'copilot') {
                    renderCopilotPage();
                    searchBarContainer.classList.add('hidden');
                    subNavContainer.classList.add('hidden');
                    formListContainer.innerHTML = '';
                    noResults.classList.add('hidden');
                    masterDivider.classList.add('hidden');
                } else {
                    renderFormListPage(page);
                    if (loadFormId) {
                        loadFormDetails(loadFormId);
                    }
                }
            }
            
            mainNavButtons.forEach(button => {
                button.addEventListener('click', () => showPage(button.dataset.page));
            });

            subNavContainer.addEventListener('click', (e) => {
                if (e.target.matches('.sub-nav-button')) {
                    subNavContainer.querySelectorAll('.sub-nav-button').forEach(btn => btn.classList.replace('active', 'inactive'));
                    e.target.classList.replace('inactive', 'active');
                    filterFormList();
                }
            });

            formListContainer.addEventListener('click', (e) => {
                if (e.target.matches('.form-list-button')) {
                    loadFormDetails(e.target.dataset.formId);
                }
            });

            searchBar.addEventListener('keyup', () => filterFormList());

            showPage('overview');
        });
    </script>
</body>
</html>

